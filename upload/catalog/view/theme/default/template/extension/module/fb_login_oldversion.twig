<div class="fb-login-error"></div>
{% if status_fb_login %}
{# Login Facebook #}
<div id="fb-root"></div>
<script>
function statusChangeCallback(response) {
    if (response.status === 'connected') {
        FB.api('/me?fields=name,id,email,first_name,last_name', function(response) {
            var email = '';
            if($('#email_input_request').is(':visible') === true ){
                email = $("#input-login-email").val();
            } else {
                email = response.email;
            }
            $.ajax({
                    url: '{{ request }}',
                    data : 'email='+email+'&fname='+response.first_name+'&lname='+response.last_name+'&fb_id='+response.id+'&login_via=facebook',
                    type : 'get',
                    success: function(json) {
                        if (json['success']) {
                            FB.logout(function(response){});
                            window.location.reload();
                        } else if (json['error']) {
                            $("#email_input_request").show();
                            for (i in json['error']) {
                                $('<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> ' + json['error'][i] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>').insertBefore($('div.fb-login-error'));
                            }
                        } else {
                            FB.logout(function(response){});
                            window.location.reload();
                        }
                    }
            });
        });
    } else if (response.status === 'not_authorized') {
        console.log('not_authorized');
    } else {
        FB.login(function(response) {
            if (response.authResponse) {
                FB.api('/me?fields=name,id,email,first_name,last_name', function(response) {
                    var email = '';
                    if($('#email_input_request').is(':visible') === true ){
                        email = $("#input-login-email").val();
                    } else {
                        email = response.email;
                    }
                    $.ajax({
                        url: '{{ request }}',
                        data : 'email='+email+'&fname='+response.first_name+'&lname='+response.last_name+'&fb_id='+response.id+'&login_via=facebook',
                        type : 'get',
                        success: function(json) {
                            if (json['success']) {
                                FB.logout(function(response){});
                                window.location.reload();
                            } else if (json['error']) {
                                $("#email_input_request").show();
                                for (i in json['error']) {
                                    $('<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> ' + json['error'][i] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>').insertBefore($('div.fb-login-error'));
                                }
                            } else {
                                FB.logout(function(response){});
                                window.location.reload();
                            }
                        }
                    });
                });
            } else {
               console.log('error_login_fb'); 
               FB.logout(function(response){});
            }
        }, {scope: 'email'});
    }
}
function loginuseronfacebook() {
    FB.getLoginStatus(function(response) {
    if (response.status == 'connected') {
        statusChangeCallback(response);
    }});
}
window.fbAsyncInit = function() {
    FB.init({
    appId      : '{{ app_id }}',
    cookie     : true,
    xfbml      : true,
    status     : true,
    version    : 'v3.2'
    });
    FB.AppEvents.logPageView();   
};
(function(d, s, id){
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) {return;}
    js = d.createElement(s); js.id = id;
    js.src = "https://connect.facebook.net/{{ location_code }}/sdk.js";
    fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script>
<hr>
<div class="col-sm-12">
    <div class="well">
    <h2>{{ text_facebook }}</h2>
    <p>{{ text_info_login }}</p>
    <div class="form-group required" id='email_input_request' style="display: none;">
        <label class="control-label" for="input-login-email">{{ entry_email }}</label>
        <input type="email" name="email" value="" placeholder="{{ entry_email_txt }}" id="input-login-email" class="form-control" />
    </div>
    <div class="fb-login-button" data-width="" data-size="large" data-button-type="login_with" data-auto-logout-link="false" data-use-continue-as="true" onlogin="loginuseronfacebook();" data-scope="email,public_profile"></div>
    <p><small>{{ login_info_popup }}</small></p>
    </div>
</div>
{% endif %}

<style>
/**
 * All of the CSS for your public-facing functionality should be
 * included in this file.
 */
.css-fbl{
    background: url("../img/fb-icon.png") no-repeat 10px center;
    background-color: #2b4170;
    background: url("../img/fb-icon.png") no-repeat 10px center, -moz-linear-gradient(top, #3b5998, #2b4170);
    background: url("../img/fb-icon.png") no-repeat 10px center, -ms-linear-gradient(top, #3b5998, #2b4170);
    background: url("../img/fb-icon.png") no-repeat 10px center, -webkit-linear-gradient(top, #3b5998, #2b4170);
    background-size: 25px 25px, cover;
    line-height: 1;
    display: block;
    padding-left: 50px;
    color: #fff !important;
    text-decoration: none !important;
    transition: opacity .3s ease-in;
    text-shadow: 1px 1px 0px #000;
    opacity: .90;
    position: relative;
    max-width: 300px;
    margin: 0 auto 16px;
}
a.css-fbl:hover{
    background-color: #062c70;
    background: url("../img/fb-icon.png") no-repeat 10px center, -moz-linear-gradient(top, #3b5998, #062C70);
    background: url("../img/fb-icon.png") no-repeat 10px center, -ms-linear-gradient(top, #3b5998, #062C70);
    background: url("../img/fb-icon.png") no-repeat 10px center, -webkit-linear-gradient(top, #3b5998, #062C70);
    background-size: 25px 25px, cover;
    color: #FDFDFD;
    opacity: 1;
}
a.css-fbl div {
    height: 45px;
    display: table-cell;
    vertical-align: middle;
}
.css-fbl img{
    display: none;
    width: 20px;
    right: 6px;
    top: 31%;
    position: absolute;
    height: auto;
}
.css-fbl.fbl-loading img{
    display: block !important;
}
.fbl_error {
    float: left;
    color: red;
    width: 100%;
}
.fbl-button{
    text-align: center;
    margin: 0 0 20px 0;
}
</style>

<link rel="dns-prefetch" href="//connect.facebook.net" />
<script type="text/javascript">
    window.fbl_started = false;
    function fbl_init(){
        try{
            window.FB.init({
                appId      : '{{ app_id }}',
                cookie     : true,
                xfbml      : true,
                status     : false,
                autoLogAppEvents : true,
                version    : 'v2.10'
            });
            window.FB.Event.subscribe('xfbml.render', function() {
                FBL.renderFinish();
            } );
            window.fbl_started = true;
        } catch (e){}
    }
    window.fbAsyncInit = function() {
        if( ! window.fbl_started )
            fbl_init()
    };

    var fbl_interval = window.setInterval(function(){
        if(window.fbl_started)
            clearInterval(fbl_interval);
        if( !window.fbl_started)
            fbl_init();
    },100);
    (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/<?= $this->locale;?>/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

</script>

{# Test area #}
{# Connect button #}
<div class="fbl-button" data-redirect="'.apply_filters( 'flp/redirect_url', $redirect).'" data-fb_nonce="' . wp_create_nonce( 'facebook-nonce' ).'">
	<img data-no-lazy="1" src="'.plugin_dir_url(__FILE__).'img/loading.svg'.'" alt="" class="fbl-spinner"/>
    <div class="fb-login-button" data-max-rows="1" onlogin="fbl_loginCheck" data-width="'.apply_filters( 'flp/button/width', '').'" data-size="'.apply_filters( 'flp/button/size', 'large').'" data-button-type="'.apply_filters( 'flp/button/type', 'login_with').'" data-show-faces="false" data-auth-type="rerequest" data-auto-logout-link="false" data-use-continue-as="'.apply_filters( 'flp/button/show_face', 'true').'" data-scope="'.apply_filters('fbl/app_scopes','email,public_profile').'"></div>
</div>

{# Disconnect button #}
<a href="?fbl_disconnect&fb_nonce='. wp_create_nonce( 'fbl_disconnect' ) .'&redirect='.urlencode( $redirect ).'" class="css-fbl "><div>'. __('Disconnect Facebook', 'fbl') .'<img data-no-lazy="1" src="'.admin_url('images/loading.gif').'" alt="" style="display:none"/></div></a>